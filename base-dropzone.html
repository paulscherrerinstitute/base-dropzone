<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../fontawesome-iconset/fa-all.html">
<script src="../dropzone/dist/dropzone.js"></script>
<!--
Element providing solution to no problem in particular.

##### Example

    <base-dropzone></base-dropzone>

@element base-dropzone
@blurb Element providing solution to no problem in particular.
@status alpha
@homepage http://.github.io/base-dropzone
-->
<dom-module id="base-dropzone">
  <template style="width: 400px;  height: 300px;">
    <link rel="stylesheet" href="../dropzone/dist/dropzone.css">
    <link rel="stylesheet" href="base-dropzone.css">
    
    <div class='vertical layout'>
      <div class='horizontal center-justified layout'>
        <form id='dropitDropzoneId'
              class="dropzone"
              enctype="multipart/form-data">
        </form>
      </div>
      <div class='horizontal layout center-justified' hidden?='{{hideProgressBar}}'>
        <paper-progress id='totalProgress' value="0"></paper-progress>
      </div>
      <div class='horizontal center-justified layout'>
        <paper-button id="submitAllBtn" hidden?='{{autoprocess}}' raised role='button' tabindex='0'>
          Upload&nbsp;
          <iron-icon icon="fa:upload"></iron-icon>
        </paper-button>
        <paper-button id="clearDropzoneBtn" raised role='button' tabindex='0'>
          Clear&nbsp;
          <iron-icon icon="fa:ban"></iron-icon>
        </paper-button>
      </div>
    </div>

  </template>
  <script>

    Polymer({
      id: 'base-dropzone',

      properties: {
        url: {type: String, value: ''},
        autoprocess: {type: Boolean, value: false},
        multiple: {type: Boolean, value: true},
        hideProgressBar: {type: Boolean, value: true},
      },

      
      ready: function () {

        if (this.url) {
          this.createDropzone();
        }
      },

      setUrl: function(url) {
        this.url = url;
        this.createDropzone();
      },

      createDropzone: function() {
        // set the options for element with id 'dropitDropzoneId'
        Dropzone.autoDiscover = false;
        var dropzoneOptions = this.createDropzoneOptions();
        new Dropzone(this.$.dropitDropzoneId, dropzoneOptions);
      },

      createDropzoneOptions: function() {
        var self = this;
        return {
          autoProcessQueue: this.autoprocess,
          uploadMultiple: this.multiple,
          parallelUploads: 100,
          maxFiles: 100,
          url: self.url,

          // The setting up of the dropzone
          init: function() {
            var dropit = this;

            // First change the button to actually tell Dropzone to process the queue.
            self.$.submitAllBtn.addEventListener("click", function(e) {
              // Make sure that the form isn't actually being sent.
              e.preventDefault();
              e.stopPropagation();
              dropit.processQueue();
            });
            
            self.$.clearDropzoneBtn.addEventListener("click", function(e) {
                // Using "_this" here, because "this" doesn't point to the dropzone anymore
                dropit.removeAllFiles();
                // If you want to cancel uploads as well, you
                // could also call _this.removeAllFiles(true);
            });

            // Listen to the sendingmultiple event. In this case, it's the sendingmultiple event instead
            // of the sending event because uploadMultiple is set to true.
            this.on("sendingmultiple", function() {
              // Gets triggered when the form is actually being sent.
              // Hide the success button or the complete form.
              self.hideProgressBar = false;
            });
            
            // updates the progress bar
            this.on("totaluploadprogress", function(progress) {
              self.$.totalProgress.value = progress;
            });

            this.on("successmultiple", function(files, response) {
              // Gets triggered when the files have successfully been sent.
              // Redirect user or notify of success.
              self.fire('dropzone-upload-success', 
                { response: response, isError: false, message: 'All files uploaded successfully.'});
              setTimeout(function() {self.hideProgressBar = true; }, 500);
            });

            this.on("errormultiple", function(files, response) {
              // Gets triggered when there was an error sending the files.
              // Maybe show form again, and notify user of error
              self.fire('dropzone-upload-failure', 
                { response: response, isError: true, message: 'Uploading files failed.'});  
            });

            this.on("maxfilesexceeded", function(files, response) {
              self.fire('dropzone-maxfiles-exceeded', 
                { response: response, isError: true, message: 'Allowed maximum number of files exceeded.'});
            });
          }
        };
      }

    });
  </script>
</dom-module>
